<script>
  let currentDistance = 0;
  let currentWeight = 0;
  let supplements = { difficultZone: false, urgentDelivery: false };

  /* --------- POIDS --------- */
  function updateWeight(value) {
    currentWeight = parseFloat(value);
    document.getElementById('weightValue').textContent = currentWeight;

    const percentage = (currentWeight / 150) * 100;
    const circumference = 2 * Math.PI * 50;
    const dashArray = (percentage / 100) * circumference;
    document.getElementById('weightGauge').style.strokeDasharray = `${dashArray} ${circumference}`;

    calculatePrice();
  }

  /* --------- SUPPL√âMENTS --------- */
  function toggleSupplement(type, element) {
    supplements[type] = !supplements[type];
    if (supplements[type]) element.classList.add('selected');
    else element.classList.remove('selected');
    calculatePrice();
  }

  /* --------- PRIX --------- */
  function calculatePrice() {
    // Distance
    let basePrice = 0, pricePerKm = 0, distanceCategory = '0 km';
    if (currentDistance > 0 && currentDistance <= 50) { basePrice = 20; pricePerKm = 0.50; distanceCategory = '0‚Äì50 km'; }
    else if (currentDistance > 0 && currentDistance <= 200) { basePrice = 50; pricePerKm = 0.40; distanceCategory = '51‚Äì200 km'; }
    else if (currentDistance > 0) { basePrice = 100; pricePerKm = 0.30; distanceCategory = '201+ km'; }

    const distancePrice = basePrice + (currentDistance * pricePerKm);
    document.getElementById('distanceCategory').textContent = currentDistance > 0 ? distanceCategory : 'Aucune distance';
    document.getElementById('distancePrice').textContent = distancePrice.toFixed(2) + '$';

    // Poids
    let weightSupplement = 0, weightCategory = '';
    if (currentWeight <= 10) { weightSupplement = 0; weightCategory = 'Inclus'; }
    else if (currentWeight <= 50) { weightSupplement = 10; weightCategory = '+10$'; }
    else if (currentWeight <= 100) { weightSupplement = 25; weightCategory = '+25$'; }
    else { weightSupplement = 50; weightCategory = '+50$'; }

    document.getElementById('weightCategory').textContent = weightCategory;
    document.getElementById('weightPrice').textContent = weightSupplement > 0 ? ('+' + weightSupplement + '$') : 'Inclus';

    // Suppl√©ments
    let otherSupplements = 0;
    let supplementsList = [];
    if (supplements.difficultZone) { otherSupplements += 15; supplementsList.push('<i class="fa-solid fa-mountain text-blue-600"></i> Zone difficile (+15$)'); }
    if (supplements.urgentDelivery) { otherSupplements += 25; supplementsList.push('<i class="fa-solid fa-truck-fast text-blue-600"></i> Livraison urgente (+25$)'); }

    // Total (hors taxes)
    const totalPrice = distancePrice + weightSupplement + otherSupplements;
    document.getElementById('totalPrice').textContent = totalPrice.toFixed(2) + '$';

    // D√©tail
    let breakdown = `
      <div class="grid md:grid-cols-2 gap-4 text-left">
        <div>
          <div class="font-semibold mb-2">üìç Transport</div>
          <div class="text-sm">Distance (${currentDistance > 0 ? distanceCategory : '‚Äî'})</div>
          <div class="text-lg font-bold">${distancePrice.toFixed(2)}$</div>
        </div>
        <div>
          <div class="font-semibold mb-2">üì¶ Poids</div>
          <div class="text-sm">${currentWeight.toFixed(1)} kg</div>
          <div class="text-lg font-bold">${weightSupplement > 0 ? ('+' + weightSupplement + '$') : 'Inclus'}</div>
        </div>
        <div class="md:col-span-2">
          <div class="font-semibold mb-2">‚ö° Suppl√©ments</div>
          <div class="text-sm">${supplementsList.length ? supplementsList.join(', ') : 'Aucun'}</div>
          <div class="text-lg font-bold">${otherSupplements > 0 ? ('+' + otherSupplements + '$') : '0$'}</div>
        </div>
      </div>`;
    document.getElementById('breakdown').innerHTML = breakdown;
  }

  function requestQuote() {
    const totalPrice = document.getElementById('totalPrice').textContent;
    alert(`üéâ Merci pour votre int√©r√™t !\n\nPrix estim√©: ${totalPrice}\n\nüìû Notre √©quipe vous contactera sous peu pour finaliser votre devis.\n\n‚ú® D.A Transport - Votre partenaire de confiance !`);
  }

  /* --------- CARTE LEAFLET + ROUTAGE --------- */
  let map, startMarker = null, endMarker = null, routingControl = null;
  let placementMode = 'start'; // 'start' ou 'end'

  function setDistanceFromRoute(km) {
    currentDistance = km || 0;
    document.getElementById('distanceValue').textContent = km ? km.toFixed(1) : '0';
    calculatePrice();
  }

  function clearRoute() {
    if (routingControl) { map.removeControl(routingControl); routingControl = null; }
  }

  function resetRoute() {
    clearRoute();
    if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
    if (endMarker)   { map.removeLayer(endMarker);   endMarker   = null; }
    placementMode = 'start';
    setDistanceFromRoute(0);
  }

  function placeStart(latlng) {
    if (!startMarker) {
      startMarker = L.marker(latlng, { draggable: true }).addTo(map).bindPopup('D√©part').openPopup();
      startMarker.on('dragend', updateRoute);
    } else {
      startMarker.setLatLng(latlng);
    }
    updateRoute();
  }

  function placeEnd(latlng) {
    if (!endMarker) {
      endMarker = L.marker(latlng, { draggable: true }).addTo(map).bindPopup('Destination').openPopup();
      endMarker.on('dragend', updateRoute);
    } else {
      endMarker.setLatLng(latlng);
    }
    updateRoute();
  }

  function updateRoute() {
    if (!(startMarker && endMarker)) { setDistanceFromRoute(0); return; }
    clearRoute();
    if (!L.Routing || !L.Routing.control) { console.warn('Leaflet Routing Machine non disponible'); return; }
    routingControl = L.Routing.control({
      waypoints: [ startMarker.getLatLng(), endMarker.getLatLng() ],
      routeWhileDragging: true,
      draggableWaypoints: true,
      show: false,
      addWaypoints: false,
      router: L.Routing.osrmv1 && L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
      createMarker: () => null
    })
    .on('routesfound', (e) => {
      const meters = e.routes[0].summary.totalDistance;
      setDistanceFromRoute(meters / 1000);
    })
    .addTo(map);
  }

  /* --------- PRESETS (ALMA / SAGUENAY / QU√âBEC) --------- */
  const presetCoords = {
    alma: [48.550, -71.650],
    saguenay: [48.428, -71.068],
    quebec: [46.813, -71.208]
  };

  // Appel√©e par les boutons onclick="presetPlace('alma' | 'saguenay' | 'quebec')"
  function presetPlace(city) {
    const coords = presetCoords[city];
    if (!coords || !map) return;

    const ll = L.latLng(coords[0], coords[1]);

    // Respecte le mode s√©lectionn√© par la toolbar (ou place logiquement)
    if (placementMode === 'start' || !startMarker) {
      placeStart(ll);
      placementMode = 'end'; // bascule auto vers destination
    } else if (placementMode === 'end' || !endMarker) {
      placeEnd(ll);
    } else {
      // Les deux existent d√©j√† ‚Üí on remplace le point s√©lectionn√© par placementMode
      if (placementMode === 'start') placeStart(ll);
      else placeEnd(ll);
    }

    map.setView(ll, 10);
  }

  function initMap() {
    if (!window.L) {
      console.error('Leaflet non charg√©.');
      return;
    }
    const alma = [48.550, -71.650];
    map = L.map('map', { tap: false }).setView(alma, 9);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // S‚Äôassure que la carte prend bien tout l‚Äôespace
    setTimeout(() => { map.invalidateSize(); }, 0);

    // Emp√™che les conteneurs parents d‚Äôintercepter les √©v√©nements
    L.DomEvent.disableScrollPropagation(map.getContainer());
    L.DomEvent.disableClickPropagation(map.getContainer());

    // Clic normal : place le point selon le mode s√©lectionn√©
    map.on('click', (e) => {
      if (placementMode === 'start') placeStart(e.latlng);
      else placeEnd(e.latlng);
      if (startMarker && !endMarker) placementMode = 'end'; // bascule auto
    });

    // Double-clic : place directement la destination
    map.on('dblclick', (e) => { placeEnd(e.latlng); });

    // Boutons de la toolbar
    document.getElementById('btnStart').addEventListener('click', () => { placementMode = 'start'; });
    document.getElementById('btnEnd').addEventListener('click', () => { placementMode = 'end'; });
    document.getElementById('btnReset').addEventListener('click', resetRoute);
  }

  window.addEventListener('load', function() {
    initMap();
    calculatePrice();
  });
</script>
